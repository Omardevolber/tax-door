<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إقرارات المستخدم</title>
  <style>
    :root{
      --bg:#f6f8fb;--card:#fff;--text:#0c223a;--muted:#5d6b7a;--line:#e6edf5;
      --acc:#2563eb;--acc-2:#1d4ed8;--ok:#16a34a;--warn:#b45309;--bad:#dc2626;--br:16px
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border-radius:var(--br);padding:18px;box-shadow:0 10px 30px rgba(2,6,23,.06);border:1px solid #eef2f7}
    h1{margin:0 0 6px;font-size:24px;font-weight:700}
    .muted{color:var(--muted);font-size:13px;margin-bottom:10px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:8px;flex-wrap:wrap}
    .lft{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid #d6e1f0;background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:all .15s ease;font-weight:600}
    .btn.primary{background:var(--acc);border-color:var(--acc-2);color:#fff}
    .btn.primary:hover{background:var(--acc-2)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .input{width:360px;max-width:60vw;border:1px solid #d6e1f0;background:#fff;border-radius:12px;padding:10px 12px}
    .table-wrap{margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:#f2f6fc;color:#1f2a37;font-weight:700;text-align:right;border-bottom:1px solid var(--line);font-size:14px}
    th,td{padding:14px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    tbody tr:hover{background:#fafcff}
    .name{font-weight:700}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid}
    .ok{background:#ecfdf5;color:var(--ok);border-color:#bbf7d0}
    .unk{background:#fff7ed;color:var(--warn);border-color:#fed7aa}
    .err{background:#fef2f2;color:var(--bad);border-color:#fecaca}
    .note{margin-top:10px;color:#8a6114;background:#fff7e6;border:1px solid #ffe2ad;padding:10px 12px;border-radius:12px;display:none}
    .empty{padding:18px;text-align:center;color:var(--muted);font-weight:600}
    .spinner{position:fixed;inset:0;background:rgba(255,255,255,.65);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:999}
    .spinner.show{display:flex}
    .spin{width:58px;height:58px;border-radius:50%;border:5px solid rgba(37,99,235,.15);border-top-color:var(--acc);animation:rot 1s linear infinite}
    @keyframes rot{to{transform:rotate(360deg)}}
    .cnt{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="spinner" id="spinner"><div class="spin"></div></div>

  <div class="wrap">
    <div class="card">
      <h1>إقرارات المستخدم</h1>

      <div class="toolbar">
        <div class="lft">
          <button class="btn" id="reloadBtn">تحديث</button>
          <button class="btn" id="zipBtn" title="تنزيل الحزمة كاملة" disabled>تنزيل الحزمة كاملة</button>
          <span class="cnt" id="countBox"></span>
        </div>

        <div class="lft">
          <input class="input" id="q" placeholder="بحث: اسم الإقرار أو الحالة..." />
          <span class="muted" id="who"></span>
        </div>
      </div>

      <div class="note" id="noteBox"></div>

      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th style="width:45%">اسم الإقرار</th>
            <th style="width:25%">حالة الإقرار</th>
            <th style="width:30%">تنزيل</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="empty" id="empty" hidden>لا توجد ملفات متاحة.</div>
      </div>
    </div>
  </div>

  <script>
    // ===== الإعدادات =====
    const API_URL = "https://quygwx9727.execute-api.us-east-1.amazonaws.com/prod/tax-door-fetch";
    const DEFAULT_DOOR = "old-door";
    const DEFAULT_FILETYPE = "اقرارات";

    // ===== اختصارات DOM =====
    const $ = id => document.getElementById(id);
    const spinner = $("spinner"), tbody = $("tbody"), emptyBox = $("empty"),
          who = $("who"), q = $("q"), noteBox = $("noteBox"),
          zipBtn = $("zipBtn"), countBox = $("countBox");

    // ===== حالة الصفحة =====
    const cache = {
      itemsAll: [],    // كل العناصر من الفetch
      itemsView: [],   // العناصر الظاهرة بعد الفلتر
      userId: ""
    };

    // ===== أدوات عامة =====
    function showSpinner(v=true){ spinner.classList.toggle("show", v); }
    function showNote(text, kind="warn"){
      noteBox.textContent = text || "";
      noteBox.style.display = text ? "block" : "none";
      noteBox.style.color = kind==="ok" ? "#166534" : (kind==="err" ? "#991b1b" : "#8a6114");
      noteBox.style.background = kind==="ok" ? "#ecfdf5" : (kind==="err" ? "#fef2f2" : "#fff7e6");
      noteBox.style.borderColor = kind==="ok" ? "#bbf7d0" : (kind==="err" ? "#fecaca" : "#ffe2ad");
    }
    function getUserId(){ return sessionStorage.getItem("userId") || ""; }
    function baseName(key){ return key?.split("/").pop() || ""; }
    function statusBadge(text){
      const v = (text||"").trim();
      let cls = "unk";
      if (/تم\s*الإرسال/.test(v)) cls = "ok";
      else if (/غير|خطأ|failed|error/i.test(v)) cls = "err";
      return `<span class="badge ${cls}">${v || "غير معروف"}</span>`;
    }
    function extractPeriodNumber(item){
      if (item.period && /^\d{6}$/.test(item.period)) return Number(item.period);
      const name = baseName(item.key)||"", m = name.match(/(\d{6})/);
      return m ? Number(m[1]) : -Infinity;
    }
    function sortItems(items){
      return (items||[]).slice().sort((a,b)=>{
        const pa = extractPeriodNumber(a), pb = extractPeriodNumber(b);
        if (pa !== pb) return pb - pa;
        const na = (baseName(a.key)||"").toLowerCase();
        const nb = (baseName(b.key)||"").toLowerCase();
        if (na < nb) return 1; if (na > nb) return -1; return 0;
      });
    }
    function directDownload(url){
      const a=document.createElement("a");
      a.href=url; a.rel="noopener noreferrer";
      document.body.appendChild(a); a.click(); a.remove();
    }

    // ===== عرض الجدول =====
    function render(items){
      const sorted = sortItems(Array.isArray(items)?items:[]);
      tbody.innerHTML = "";
      emptyBox.hidden = sorted.length !== 0;

      for (const it of sorted){
        const periodOrName = it.period ? it.period : baseName(it.key);
        const url = it.download_url;
        const st = it.status || "غير معروف";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="name">${periodOrName}</td>
          <td>${statusBadge(st)}</td>
          <td>
            <button class="btn" onclick="directDownload('${url.replace(/'/g,"\\'")}')">تنزيل</button>
          </td>`;
        tbody.appendChild(tr);
      }

      countBox.textContent = sorted.length
        ? `الظاهرة: ${sorted.length} / الإجمالي: ${cache.itemsAll.length}`
        : "";
      zipBtn.disabled = sorted.length === 0;
      cache.itemsView = sorted;
    }

    // ===== فلترة البحث =====
    function applyFilter(){
      const t = (q.value || "").trim();
      if (!t){
        render(cache.itemsAll);
        return;
      }
      const rx = new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"), "i");
      const filtered = cache.itemsAll.filter(it=>{
        const name = baseName(it.key)||"";
        const p = it.period || "";
        const s = it.status || "";
        return rx.test(name) || rx.test(p) || rx.test(s);
      });
      render(filtered);
    }

    // ===== جلب البيانات من اللامبدا =====
    async function fetchData(){
      cache.userId = getUserId();
      who.textContent = cache.userId ? cache.userId : "لا يوجد userId في sessionStorage";

      if (!cache.userId){
        render([]); showNote("أدخل userId في sessionStorage أولًا."); return;
      }

      showSpinner(true); showNote("");

      try{
        const payload = { userId: cache.userId, door: DEFAULT_DOOR, fileType: DEFAULT_FILETYPE };
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const raw = await res.text();
        console.log("fetch status:", res.status, "raw first 120:", raw.slice(0,120));
        let data;
        try{ data = JSON.parse(raw); } catch{ throw new Error("استجابة غير صالحة (ليست JSON)."); }

        if (!res.ok){ throw new Error(data?.message || `HTTP ${res.status}`); }

        cache.itemsAll = Array.isArray(data.items) ? data.items : [];
        render(cache.itemsAll);

        if (data.note){ showNote(data.note, "warn"); }
      } catch(err){
        console.error("FETCH error:", err);
        render([]); showNote("خطأ: " + (err?.message || err), "err");
      } finally{
        showSpinner(false);
      }
    }

    // ===== إنشاء وتنزيل الحزمة (باستخدام العناصر الظاهرة فقط) =====
    async function handlePackageZip(){
      const items = cache.itemsView || [];
      if (!items.length){ return showNote("لا توجد عناصر لتجميعها."); }

      zipBtn.setAttribute("disabled","true");
      showSpinner(true); showNote("");

      try{
        const zipName = `declarations_${new Date().toISOString().replace(/[:.]/g,"-")}.zip`;
        const payload = { action:"package", items, zip_name: zipName };

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const ct = res.headers.get("content-type") || "";
        const raw = await res.text();
        console.log("package status:", res.status, "ct:", ct, "raw first 120:", raw.slice(0,120));

        let data = null;
        try{ data = JSON.parse(raw); }catch{
          // احتمال API GW يرجّع Base64 نصي لJSON
          if (/^[A-Za-z0-9+/=\r\n]+$/.test(raw) && raw.length % 4 === 0){
            try{
              const decoded = atob(raw.replace(/\s+/g,""));
              data = JSON.parse(decoded);
              console.warn("parsed base64 JSON from API Gateway");
            }catch{}
          }
        }

        if (!res.ok){
          const msg = data?.message || data?.error || `HTTP ${res.status}`;
          throw new Error(`فشل إنشاء الحزمة: ${msg}`);
        }

        if (data?.zip_url){
          directDownload(data.zip_url);
          showNote(`تم إنشاء الحزمة ${(data.size_bytes?`(${(data.size_bytes/1e6).toFixed(1)} MB)`:``)}.`, "ok");
          return;
        }

        // fallback نادر: ZIP باينري
        if (/application\/zip/i.test(ct) || raw.startsWith("PK")){
          const blob = raw.startsWith("PK")
            ? new Blob([new TextEncoder().encode(raw)], {type:"application/zip"})
            : new Blob([raw], {type:"application/zip"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = zipName;
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          showNote("تم تحميل الحزمة مباشرة من الاستجابة.", "ok");
          return;
        }

        throw new Error("استجابة غير متوقعة من الخادم (لا يوجد zip_url ولا ZIP).");
      } catch(err){
        console.error("ZIP error:", err);
        showNote(`تعذّر إنشاء وتنزيل الحزمة: ${(err && err.message) || err}`, "err");
      } finally{
        zipBtn.removeAttribute("disabled");
        showSpinner(false);
      }
    }

    // ===== تهيئة =====
    (function init(){
      $("reloadBtn").addEventListener("click", fetchData);
      zipBtn.addEventListener("click", handlePackageZip);
      q.addEventListener("input", applyFilter);

      cache.userId = getUserId();
      who.textContent = cache.userId ? cache.userId : "لا يوجد userId في sessionStorage";
      if (cache.userId) fetchData();
      else render([]);
    })();
  </script>
</body>
</html>

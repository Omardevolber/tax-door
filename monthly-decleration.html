<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إقرارات المستخدم</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --primary:#2563eb;
      --primary-600:#1d4ed8;
      --ring:#e5e7eb;
      --warn:#b45309;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.5 "Cairo","Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .page{
      max-width:900px; margin:40px auto; padding:0 12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--ring);
      border-radius:16px;
      box-shadow:0 4px 12px rgba(0,0,0,.04);
      overflow:hidden;
    }
    .card-h{
      padding:18px 18px 6px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .card-h h2{
      margin:0; font-size:22px; font-weight:700;
    }
    .toolbar{
      padding:12px 18px 18px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--ring); background:#fff; color:var(--text);
      padding:8px 12px; border-radius:10px; cursor:pointer;
      font-weight:600;
    }
    .btn.primary{ background:var(--primary); color:#fff; border-color:var(--primary); }
    .btn.primary:hover{ background:var(--primary-600); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .input{
      min-width:260px; flex:1 1 280px;
      border:1px solid var(--ring); background:#fff; color:var(--text);
      padding:8px 12px; border-radius:10px; outline:none;
    }
    .subtle{
      color:var(--muted); font-size:13px; user-select:text;
    }
    .notice{
      background:#fff7ed; color:#92400e; border:1px solid #fed7aa;
      margin:0 18px 12px; border-radius:10px; padding:10px 12px; display:none;
    }

    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{
      text-align:right; font-weight:700; font-size:14px; color:var(--muted);
      padding:12px 16px; background:#f9fafb; border-bottom:1px solid var(--ring);
    }
    tbody td{ padding:14px 16px; border-bottom:1px solid var(--ring); }
    tbody tr:last-child td{ border-bottom:none; }
    .cell-name{ font-weight:700; }
    .cell-status{ color:var(--muted); }
    .table-wrap{ overflow:auto; }
    .empty{
      text-align:center; color:var(--muted); padding:26px 12px;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="card" id="card">

      <div class="card-h">
        <h2>إقرارات المستخدم</h2>
        <button id="refreshBtn" class="btn">تحديث</button>
      </div>

      <div class="toolbar">
        <button id="zipAllBtn" class="btn">تنزيل الحزمة كاملة</button>
        <input id="searchBox" class="input" type="text" placeholder="بحث: اسم الإقرار أو الحالة..." />
        <span id="userHint" class="subtle"></span>
      </div>

      <div id="notice" class="notice">تعذّر إنشاء وتنزيل الحزمة.</div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:40%">اسم الإقرار</th>
              <th style="width:40%">حالة الإقرار</th>
              <th style="width:20%">تنزيل</th>
            </tr>
          </thead>
          <tbody id="tableBody" data-role="items">
            <tr id="emptyRow"><td colspan="3" class="empty">لا توجد ملفات متاحة.</td></tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- يمكنك وضع الـ userId هنا أو بالـ sessionStorage (الأفضل تخزينه عند تسجيل الدخول) -->
  <div id="ctx" data-userid=""></div>

  <script>
  // ===================== الإعدادات =====================
  const API_URL = "https://quygwx9727.execute-api.us-east-1.amazonaws.com/prod/tax-door-fetch";
  const DEFAULT_DOOR = "old-door";
  const DEFAULT_FILETYPE = "اقرارات";

  // ============== أدوات مساعدة خفيفة ==============
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  function baseName(k){ return (k||"").split("/").pop() || ""; }
  function statusText(s){ return s || "غير معروف"; }
  function getUserId(){
    return sessionStorage.getItem("userId")
        || $("#ctx")?.getAttribute("data-userid")
        || "";
  }
  function showNotice(txt){
    const n = $("#notice");
    if (!n) return;
    n.textContent = txt || "تعذّر إنشاء وتنزيل الحزمة.";
    n.style.display = "block";
    setTimeout(()=> n.style.display = "none", 4000);
  }

  // يفك أي envelope من API Gateway (statusCode/body/isBase64Encoded) أو JSON مباشر
  function unwrap(rawText){
    let j; try{ j = JSON.parse(rawText); }catch{ return {ok:false,error:"JSON غير صالح"}; }
    if (j && typeof j==="object" && "statusCode" in j && "body" in j){
      if (j.isBase64Encoded){
        try{ return { ok:true, data: JSON.parse(atob(String(j.body))), statusCode:j.statusCode }; }
        catch{ return { ok:false, error:"body base64 غير قابل للفك" }; }
      } else {
        try{ return { ok:true, data: JSON.parse(j.body), statusCode:j.statusCode }; }
        catch{ return { ok:false, error:"body ليس JSON" }; }
      }
    }
    return { ok:true, data:j };
  }

  // يلقط العناصر أيا كان اسم المفتاح الراجع
  function extractItems(data){
    if (!data || typeof data!=="object") return [];
    const candidates = [
      data.items, data.files, data.list, data.results, data.data?.items, data.data?.files
    ].filter(Array.isArray);
    return candidates[0] || [];
  }

  // ============== رسم الجدول ==============
  function toggleEmpty(show){
    const r = $("#emptyRow");
    if (r) r.style.display = show ? "table-row" : "none";
  }

  function render(items){
    const tb = $("#tableBody");
    const zipBtn = $("#zipAllBtn");
    if (!tb) return;

    tb.innerHTML = "";
    if (!items.length){
      toggleEmpty(true);
      if (zipBtn) zipBtn.disabled = true;
      return;
    }
    toggleEmpty(false);
    if (zipBtn) zipBtn.disabled = false;

    for (const it of items){
      const name = it.period || baseName(it.key) || baseName(it.name) || "بدون اسم";
      const url  = it.download_url || it.url || it.link;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="cell-name">${name}</td>
        <td class="cell-status">${statusText(it.status)}</td>
        <td>${url ? `<a href="${url}" download rel="noopener">تنزيل</a>` : "-"}</td>
      `;
      tb.appendChild(tr);
    }
  }

  // ============== الحالة العامة ==============
  const state = { all: [], view: [] };

  // ============== الجلب ==============
  async function fetchFiles(){
    const userId = getUserId();
    $("#userHint").textContent = userId ? `المستخدم: ${userId}` : "";
    if (!userId){ render([]); return; }

    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ userId, door: DEFAULT_DOOR, fileType: DEFAULT_FILETYPE })
      });
      const raw = await res.text();
      console.log("fetch status:", res.status, "raw first 120:", raw.slice(0,120));
      const uw = unwrap(raw);
      if (!uw.ok) throw new Error(uw.error);

      const data  = uw.data || {};
      const items = extractItems(data);
      console.log("items length:", items.length, {keys:Object.keys(data)});
      state.all  = items;
      state.view = items;
      render(items);
    } catch(e){
      console.error("Fetch error:", e);
      render([]);
    }
  }

  // ============== إنشاء الحزمة (يرجع لينك فقط) ==============
  async function makeZip(){
    if (!state.view.length) return;
    const zipName = `declarations_${new Date().toISOString().replace(/[:.]/g,"-")}.zip`;
    try{
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ action:"package", items: state.view, zip_name: zipName })
      });
      const raw = await res.text();
      console.log("package status:", res.status, "raw first 120:", raw.slice(0,120));
      const uw = unwrap(raw);
      if (!uw.ok) throw new Error(uw.error);
      const data = uw.data || {};
      const url  = data.zip_url || data.url || data.presigned_url;
      if (url){
        const a = document.createElement("a"); a.href = url; a.rel="noopener"; a.click();
      }else{
        console.warn("لا يوجد zip_url في الاستجابة:", data);
        showNotice("تعذّر إنشاء وتنزيل الحزمة.");
      }
    }catch(e){
      console.error("Package error:", e);
      showNotice("تعذّر إنشاء وتنزيل الحزمة.");
    }
  }

  // ============== البحث ==============
  function applyFilter(){
    const box = $("#searchBox");
    const t = (box?.value || "").trim();
    if (!t){ render(state.all); return; }
    const rx = new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"), "i");
    render(state.all.filter(it=>{
      const nm = it.period || baseName(it.key) || baseName(it.name) || "";
      return rx.test(nm) || rx.test(it.status||"");
    }));
  }

  // ============== الربط والتشغيل ==============
  (function init(){
    $("#refreshBtn")?.addEventListener("click", fetchFiles);
    $("#zipAllBtn")?.addEventListener("click", makeZip);
    $("#searchBox")?.addEventListener("input", applyFilter);
    fetchFiles(); // تحميل أولي
  })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إقرارات المستخدم</title>
  <style>
    :root{
      --bg:#f6f8fb;--card:#fff;--text:#0c223a;--muted:#5d6b7a;--line:#e6edf5;
      --acc:#2563eb;--acc-2:#1d4ed8;--ok:#16a34a;--warn:#b45309;--bad:#dc2626;--br:16px
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border-radius:var(--br);padding:18px;box-shadow:0 10px 30px rgba(2,6,23,.06);border:1px solid #eef2f7}
    h1{margin:0 0 6px;font-size:24px;font-weight:700}
    .muted{color:var(--muted);font-size:13px;margin-bottom:10px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:8px;flex-wrap:wrap}
    .lft{display:flex;gap:8px;align-items:center}
    .btn{appearance:none;border:1px solid #d6e1f0;background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:all .15s ease;font-weight:600}
    .btn.primary{background:var(--acc);border-color:var(--acc-2);color:#fff}
    .btn.primary:hover{background:var(--acc-2)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .input{width:360px;max-width:60vw;border:1px solid #d6e1f0;background:#fff;border-radius:12px;padding:10px 12px}
    .table-wrap{margin-top:10px;border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{background:#f2f6fc;color:#1f2a37;font-weight:700;text-align:right;border-bottom:1px solid var(--line);font-size:14px}
    th,td{padding:14px 12px;border-bottom:1px solid var(--line);vertical-align:middle}
    tbody tr:hover{background:#fafcff}
    .name{font-weight:700}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:4px 10px;border-radius:999px;font-size:12px;border:1px solid}
    .ok{background:#ecfdf5;color:var(--ok);border-color:#bbf7d0}
    .unk{background:#fff7ed;color:var(--warn);border-color:#fed7aa}
    .err{background:#fef2f2;color:var(--bad);border-color:#fecaca}
    .note{margin-top:10px;color:#8a6114;background:#fff7e6;border:1px solid #ffe2ad;padding:10px 12px;border-radius:12px;display:none}
    .empty{padding:18px;text-align:center;color:var(--muted);font-weight:600}
    .spinner{position:fixed;inset:0;background:rgba(255,255,255,.65);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:999}
    .spinner.show{display:flex}
    .spin{width:58px;height:58px;border-radius:50%;border:5px solid rgba(37,99,235,.15);border-top-color:var(--acc);animation:rot 1s linear infinite}
    @keyframes rot{to{transform:rotate(360deg)}}
    .cnt{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="spinner" id="spinner"><div class="spin"></div></div>

  <div class="wrap">
    <div class="card">
      <h1>إقرارات المستخدم</h1>

      <div class="toolbar">
        <div class="lft">
          <button class="btn" id="reloadBtn">تحديث</button>
          <button class="btn" id="zipBtn" title="تنزيل الحزمة كاملة" disabled>تنزيل الحزمة كاملة</button>
          <span class="cnt" id="countBox"></span>
        </div>

        <div class="lft">
          <input class="input" id="q" placeholder="بحث: اسم الإقرار أو الحالة..." />
          <span class="muted" id="who"></span>
        </div>
      </div>

      <div class="note" id="noteBox"></div>

      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th style="width:45%">اسم الإقرار</th>
            <th style="width:25%">حالة الإقرار</th>
            <th style="width:30%">تنزيل</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="empty" id="empty" hidden>لا توجد ملفات متاحة.</div>
      </div>
    </div>
  </div>

<script>
/** =========[ CONFIG ]========= */
const API_URL = "https://quygwx9727.execute-api.us-east-1.amazonaws.com/prod/tax-door-fetch";
const DEFAULT_DOOR = "old-door";
const DEFAULT_FILETYPE = "اقرارات";

/* لو IDs بتاعتك مختلفة غيّر السلكتورز هنا بس */
const UI = {
  refreshBtn:  "#refreshBtn",     // زر "تحديث"
  zipBtn:      "#zipAllBtn",      // زر "تنزيل الحزمة كاملة"
  searchBox:   "#searchBox",      // حقل البحث
  tbody:       "#tableBody",      // جسم الجدول
  emptyRow:    "#emptyRow",       // سطر "لا توجد ملفات متاحة."
  noteBox:     "#noteBox",        // صندوق الملاحظة/الخطأ
  userIdText:  "#userIdText"      // عنصر نصّي يظهر فيه userId (اختياري)
};

/** =========[ أدوات عامة ]========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function showNote(msg, kind="warn") {
  const box = $(UI.noteBox);
  if (!box) return;
  box.textContent = msg || "";
  box.style.display = msg ? "block" : "none";
  box.style.color = kind==="ok" ? "#166534" : (kind==="err" ? "#991b1b" : "#8a6114");
}

function baseName(key){ return (key||"").split("/").pop() || ""; }
function statusBadgeText(s){ return s || "غير معروف"; }

function getUserId(){
  // لو أنت بتحقن الـ userId في الصفحة، سيبه في sessionStorage مرة واحدة:
  // sessionStorage.setItem('userId','54b8...');
  return sessionStorage.getItem("userId") || "";
}

/** نفكّ استجابة API Gateway (statusCode/body/isBase64Encoded) */
function unwrapGatewayResponse(rawText){
  let data;
  try { data = JSON.parse(rawText); } catch { return { ok:false, error:"استجابة غير صالحة (ليست JSON)" }; }
  // لو شكل envelope
  if (data && typeof data === "object" && "statusCode" in data && "body" in data) {
    if (data.isBase64Encoded) {
      try {
        const decoded = atob(String(data.body));
        return { ok:true, data: JSON.parse(decoded), statusCode: data.statusCode };
      } catch(e){
        return { ok:false, error:"body base64 غير قابل للفك/القراءة" };
      }
    } else {
      try { return { ok:true, data: JSON.parse(data.body), statusCode: data.statusCode }; }
      catch(e){ return { ok:false, error:"body ليس JSON" }; }
    }
  }
  // أو كانت JSON مباشرة (بدون envelope)
  return { ok:true, data };
}

/** ترتيب العناصر تنازلياً حسب رقم الفترة داخل اسم الملف */
function sortItems(items){
  function getP(it){
    if (it.period && /^\d{6}$/.test(it.period)) return Number(it.period);
    const m = (baseName(it.key)||"").match(/(\d{6})/);
    return m ? Number(m[1]) : -Infinity;
  }
  return (items||[]).slice().sort((a,b)=>{
    const pa = getP(a), pb = getP(b);
    if (pb !== pa) return pb - pa;
    return (baseName(b.key)||"").localeCompare(baseName(a.key)||"");
  });
}

/** =========[ حالة عامة ]========= */
const state = { all: [], view: [] };

/** =========[ رسم الجدول ]========= */
function render(items){
  const tb = $(UI.tbody);
  const empty = $(UI.emptyRow);
  const zipBtn = $(UI.zipBtn);
  if (!tb) return;

  const rows = sortItems(items);
  tb.innerHTML = "";

  if (!rows.length) {
    if (empty) empty.style.display = "table-row";
    if (zipBtn) zipBtn.disabled = true;
    return;
  }
  if (empty) empty.style.display = "none";
  if (zipBtn) zipBtn.disabled = false;

  for (const it of rows) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="name">${it.period || baseName(it.key)}</td>
      <td>${statusBadgeText(it.status)}</td>
      <td><a href="${it.download_url}" rel="noopener" download>تنزيل</a></td>
    `;
    tb.appendChild(tr);
  }
  state.view = rows;
}

/** =========[ جلب الملفات ]========= */
async function fetchFiles(){
  showNote(""); if ($(UI.zipBtn)) $(UI.zipBtn).disabled = true;

  const userId = getUserId();
  if ($(UI.userIdText)) $(UI.userIdText).textContent = userId || "";
  if (!userId){ render([]); showNote("لا يوجد userId في sessionStorage.", "err"); return; }

  try{
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ userId, door: DEFAULT_DOOR, fileType: DEFAULT_FILETYPE })
    });
    const raw = await res.text();
    console.log("fetch status:", res.status, "raw first 120:", raw.slice(0,120));

    const uw = unwrapGatewayResponse(raw);
    if (!uw.ok) throw new Error(uw.error || "فشل قراءة الاستجابة");
    const data = uw.data;

    state.all = Array.isArray(data.items) ? data.items : [];
    render(state.all);

    if (data.note) showNote(data.note, "warn");
  } catch(err){
    console.error(err);
    render([]);
    showNote("خطأ في الجلب: " + (err?.message || err), "err");
  }
}

/** =========[ تجميع ZIP (روابط الجدول فقط) ]========= */
async function makeZip(){
  const zipBtn = $(UI.zipBtn);
  if (zipBtn) zipBtn.disabled = true;
  showNote("");

  try{
    if (!state.view.length) { showNote("لا توجد عناصر لتجميعها."); return; }
    const zipName = `declarations_${new Date().toISOString().replace(/[:.]/g,"-")}.zip`;

    const res = await fetch(API_URL, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ action:"package", items: state.view, zip_name: zipName })
    });
    const raw = await res.text();
    console.log("package status:", res.status, "raw first 120:", raw.slice(0,120));

    const uw = unwrapGatewayResponse(raw);
    if (!uw.ok) throw new Error(uw.error || "فشل قراءة استجابة الحزمة");
    const data = uw.data;

    if (data.zip_url){
      // ننزل باللينك فقط (مش بنرجّع الباينري)
      const a = document.createElement("a");
      a.href = data.zip_url; a.rel="noopener"; a.click();
      showNote("تم إنشاء الحزمة وإتاحة رابط التحميل.", "ok");
    } else {
      throw new Error("استجابة غير متوقعة: لا يوجد zip_url.");
    }
  } catch(err){
    console.error(err);
    showNote("تعذّر إنشاء وتنزيل الحزمة: " + (err?.message || err), "err");
  } finally {
    if (zipBtn) zipBtn.disabled = false;
  }
}

/** =========[ بحث/فلترة ]========= */
function applyFilter(){
  const box = $(UI.searchBox);
  if (!box) return render(state.all);
  const t = (box.value||"").trim();
  if (!t) return render(state.all);
  const rx = new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"), "i");
  render(state.all.filter(it=>{
    const name = baseName(it.key)||"";
    return rx.test(name) || rx.test(it.period||"") || rx.test(it.status||"");
  }));
}

/** =========[ ربط الأحداث ]========= */
(function init(){
  const r = $(UI.refreshBtn), z = $(UI.zipBtn), s = $(UI.searchBox);
  if (r) r.addEventListener("click", fetchFiles);
  if (z) z.addEventListener("click", makeZip);
  if (s) s.addEventListener("input", applyFilter);

  // تحميل مبدئي إن وُجد userId
  if (getUserId()) fetchFiles();
})();
</script>

</body>
</html>


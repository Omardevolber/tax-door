<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .box {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 30px;
      width: 90%;
      max-width: 600px;
      text-align: center;
    }
    h1 { color: #333; }
    .info { text-align: left; margin-top: 20px; }
    button {
      background: #0073bb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h1>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ğŸ‘‹</h1>
    <div id="userInfo" class="info">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>

  <script>
    const CLIENT_ID = "4ffqait6u9o2q22u1g39vt0454";
    const DOMAIN = "https://us-east-1hrn5jyv1p.auth.us-east-1.amazoncognito.com";
    const REDIRECT_URI = "https://omardevolber.github.io/tax-door/";
    const REGION = "us-east-1";

    // 1ï¸âƒ£ Ù„Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©
    const savedUser = sessionStorage.getItem("cognitoUser");
    if (savedUser) {
      renderUser(JSON.parse(savedUser));
    } else {
      // 2ï¸âƒ£ Ø§Ù„ØªÙ‚Ø· ÙƒÙˆØ¯ Ø§Ù„ØªÙÙˆÙŠØ¶ Ù…Ù† Ø§Ù„Ù€ URL
      const code = new URLSearchParams(window.location.search).get("code");
      if (!code) {
        // Ù„Ùˆ Ù…ÙÙŠØ´ ÙƒÙˆØ¯ØŒ Ø§Ø±Ø¬Ø¹Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        window.location.href = `${DOMAIN}/login?client_id=${CLIENT_ID}&response_type=code&scope=aws.cognito.signin.user.admin+email+openid+phone&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
      } else {
        exchangeCodeForToken(code);
      }
    }

    // 3ï¸âƒ£ ØªØ¨Ø§Ø¯Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù€ Tokens
    async function exchangeCodeForToken(code) {
      const tokenUrl = `${DOMAIN}/oauth2/token`;
      const body = new URLSearchParams({
        grant_type: "authorization_code",
        client_id: CLIENT_ID,
        code,
        redirect_uri: REDIRECT_URI
      });

      try {
        const res = await fetch(tokenUrl, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });

        const data = await res.json();
        const idToken = data.id_token;

        if (!idToken) {
          document.getElementById("userInfo").innerText = "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.";
          return;
        }

        // 4ï¸âƒ£ ÙÙƒ Ø´ÙØ±Ø© Ø§Ù„Ù€ JWT Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const payload = JSON.parse(atob(idToken.split('.')[1]));
        const user = {
          userId: payload.sub,
          username: payload['cognito:username'],
          email: payload.email,
          phone_number: payload.phone_number
        };

        // 5ï¸âƒ£ Ø®Ø²Ù†Ù‡Ø§ ÙÙŠ sessionStorage
        sessionStorage.setItem("cognitoUser", JSON.stringify(user));

        renderUser(user);
      } catch (err) {
        console.error(err);
        document.getElementById("userInfo").innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
      }
    }

    // 6ï¸âƒ£ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
    function renderUser(user) {
      document.getElementById("userInfo").innerHTML = `
        <strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${user.username}<br>
        <strong>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${user.phone_number || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}<br>
        <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</strong> ${user.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}<br>
        <strong>User ID:</strong> ${user.userId}
      `;
    }

    // 7ï¸âƒ£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    function logout() {
      sessionStorage.clear();
      window.location.href = `${DOMAIN}/logout?client_id=${CLIENT_ID}&logout_uri=${encodeURIComponent(REDIRECT_URI)}`;
    }
  </script>
</body>
</html>

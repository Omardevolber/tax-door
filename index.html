<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم | Tax Door</title>
  <style>
    body{
      font-family: 'Cairo', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:#f8fafc;margin:0;padding:0;display:flex;flex-direction:column;align-items:center;min-height:100vh
    }
    header{width:100%;background:#004c91;color:#fff;padding:20px 0;text-align:center;font-size:24px;font-weight:700}
    .user-box{background:#fff;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);padding:20px;width:90%;max-width:800px;margin-top:24px}
    .user-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px 20px}
    .user-grid p{margin:.25rem 0;font-size:14px;color:#222}
    .user-grid strong{color:#004c91}
    .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;width:90%;max-width:1000px;margin-top:28px}
    .card{background:#fff;border-radius:16px;padding:24px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,.08);transition:transform .25s, box-shadow .25s;cursor:pointer}
    .card:hover{transform:translateY(-4px);box-shadow:0 8px 18px rgba(0,0,0,.12)}
    .card h3{color:#004c91;margin:0 0 8px 0;font-size:18px}
    .card p{color:#555;margin:0;font-size:13px}
    button.logout{background:#d9534f;color:#fff;border:none;border-radius:10px;padding:10px 18px;cursor:pointer;margin-top:18px;transition:background .25s}
    button.logout:hover{background:#b52b27}
    footer{margin-top:auto;padding:16px;color:#888;font-size:13px}
  </style>
</head>
<body>
  <header>لوحة التحكم - Tax Door</header>

  <button class="logout" onclick="logout()">🚪 تسجيل الخروج</button>

  <div class="user-box" id="userBox">
    <div class="user-grid">
      <p><strong>👤 الاسم:</strong> <span id="name">—</span></p>
      <p><strong>📧 البريد:</strong> <span id="email">—</span></p>
      <p><strong>📱 الهاتف:</strong> <span id="phone">—</span></p>
      <p><strong>🆔 المعرّف (userId):</strong> <span id="userId">—</span></p>
      <p><strong>👤 اسم المستخدم:</strong> <span id="username">—</span></p>
    </div>
  </div>

  <div class="container">
    <div class="card" onclick="openPage('download_income_declarations.html')">
      <h3>📄 إقرارات الدخل</h3>
      <p>تحميل جميع إقرارات ضريبة الدخل المسجلة.</p>
    </div>

    <div class="card" onclick="openPage('download_portal_payment_receipts.html')">
      <h3>💳 إيصالات الدفع الإلكتروني</h3>
      <p>عرض وتحميل إيصالات الدفع من البوابة.</p>
    </div>

    <div class="card" onclick="openPage('download_withholding_.html')">
      <h3>📑 نماذج الخصم والتحصيل</h3>
      <p>إدارة ملفات الخصم (نموذج 41).</p>
    </div>

    <div class="card" onclick="openPage('monthly-decleration.html')">
      <h3>📆 الإقرارات الشهرية</h3>
      <p>إدارة وتنزيل الإقرارات الشهرية بسهولة.</p>
    </div>

    <div class="card" onclick="openLegacy()">
      <h3>🗂️ لتسجيل جديد</h3>
      <p>إدخال بيانات البوابة الضريبية القديمة</p>
    </div>
  </div>

  <footer>© 2025 Tax Door System</footer>

  <script>
    // ======== إعدادات كوجنيتو ========
    const CLIENT_ID   = "4ffqait6u9o2q22u1g39vt0454";
    const DOMAIN      = "https://us-east-1hrn5jyv1p.auth.us-east-1.amazoncognito.com";
    const REDIRECT_URI= "https://omardevolber.github.io/tax-door/";

    // ======== فكّ JWT مع دعم UTF-8 (لعربي) ========
    function parseJwtUtf8(token){
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
      const binary = atob(base64);
      // binary -> UTF-8 safe string
      const percentEncoded = Array.prototype.map.call(binary, ch => {
        const hex = ch.charCodeAt(0).toString(16).padStart(2,'0');
        return '%' + hex;
      }).join('');
      const json = decodeURIComponent(percentEncoded);
      return JSON.parse(json);
    }

    // ======== فتح صفحات في نفس التبويب ========
    function openPage(page){ window.location.href = page; }

    function openLegacy() {
      const uid = sessionStorage.getItem("userId") || sessionStorage.getItem("useId");
      if (!uid){ alert("❗ مفيش userId في الـ sessionStorage — ارجع سجّل دخول الأول."); return; }
      const url = "https://2d545906-4abd-4cc3-a694-9d80f68249c9-00-2b5dubctbx6hg.kirk.replit.dev/?userId=" + encodeURIComponent(uid);
      window.location.href = url; // نفس التبويب
    }

    // ======== عرض بيانات المستخدم في الواجهة ========
    function renderUser(){
      document.getElementById("name").textContent     = sessionStorage.getItem("name") || "غير متوفر";
      document.getElementById("username").textContent = sessionStorage.getItem("username") || "غير متوفر";
      document.getElementById("email").textContent    = sessionStorage.getItem("email") || "غير متوفر";
      document.getElementById("phone").textContent    = sessionStorage.getItem("phone_number") || "غير متوفر";
      document.getElementById("userId").textContent   = sessionStorage.getItem("userId") || "غير متوفر";
    }

    // ======== تبادل الكود بالتوكن ========
    async function exchangeCodeForToken(code){
      const tokenUrl = `${DOMAIN}/oauth2/token`;
      const body = new URLSearchParams({
        grant_type: "authorization_code",
        client_id: CLIENT_ID,
        code,
        redirect_uri: REDIRECT_URI
      });

      try{
        const res = await fetch(tokenUrl, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });
        const data = await res.json();

        const idToken = data.id_token;
        if(!idToken){ alert("فشل تسجيل الدخول من كوجنيتو"); return; }

        const payload = parseJwtUtf8(idToken);

        // تخزين القيم (مع دعم العربي)
        sessionStorage.setItem("userId", payload.sub || "");
        sessionStorage.setItem("username", payload['cognito:username'] || "");
        sessionStorage.setItem("email", payload.email || "");
        sessionStorage.setItem("phone_number", payload.phone_number || "");
        sessionStorage.setItem("name", payload.name || payload.given_name || "");

        // نظّف باراميتر ?code من الرابط بعد ما خلصنا
        if (window.history && window.history.replaceState) {
          const cleanUrl = window.location.origin + window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
        }

        renderUser();
      }catch(err){
        console.error(err);
        alert("حدث خطأ أثناء تسجيل الدخول");
      }
    }

    // ======== فحص الجلسة عند التحميل ========
    (function init(){
      const userId   = sessionStorage.getItem("userId");
      const username = sessionStorage.getItem("username");

      if (!userId || !username){
        const url = new URL(window.location.href);
        const code = url.searchParams.get("code");
        if (!code){
          // نضمن طلب scope فيه profile عشان name/given_name
          const scope = encodeURIComponent("aws.cognito.signin.user.admin email openid phone profile");
          window.location.href = `${DOMAIN}/login?client_id=${CLIENT_ID}&response_type=code&scope=${scope}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
        } else {
          exchangeCodeForToken(code);
        }
      } else {
        renderUser();
      }
    })();

    // ======== تسجيل الخروج ========
    function logout(){
      sessionStorage.clear();
      const scope = encodeURIComponent("email openid phone profile");
      window.location.href =
        `${DOMAIN}/login?client_id=${CLIENT_ID}&response_type=code&scope=${scope}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
    }
  </script>
</body>
</html>

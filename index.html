<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لوحة التحكم | Tax Door</title>
  <style>
    body{
      font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:#f8fafc;margin:0;padding:0;display:flex;flex-direction:column;align-items:center;min-height:100vh
    }
    header{width:100%;background:#004c91;color:#fff;padding:20px 0;text-align:center;font-size:24px;font-weight:700}
    .user-box{background:#fff;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);padding:20px;width:90%;max-width:800px;margin-top:24px}
    .user-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px 20px}
    .user-grid p{margin:.25rem 0;font-size:14px;color:#222}
    .user-grid strong{color:#004c91}
    .container{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;width:90%;max-width:1000px;margin-top:28px}
    .card{background:#fff;border-radius:16px;padding:24px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,.08);transition:transform .25s, box-shadow .25s;cursor:pointer}
    .card:hover{transform:translateY(-4px);box-shadow:0 8px 18px rgba(0,0,0,.12)}
    .card h3{color:#004c91;margin:0 0 8px 0;font-size:18px}
    .card p{color:#555;margin:0;font-size:13px}
    button.logout{background:#d9534f;color:#fff;border:none;border-radius:10px;padding:10px 18px;cursor:pointer;margin-top:18px;transition:background .25s}
    button.logout:hover{background:#b52b27}
    footer{margin-top:auto;padding:16px;color:#888;font-size:13px}

    /* ===== Spinner Overlay ===== */
    .overlay{
      position:fixed;inset:0;background:rgba(255,255,255,.8);
      display:none;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(2px)
    }
    .overlay.show{display:flex}
    .spinner{
      width:56px;height:56px;border-radius:50%;
      border:4px solid #cfe3f6;border-top-color:#004c91;
      animation:spin .9s linear infinite
    }
    .overlay-text{margin-top:12px;color:#004c91;font-weight:600;font-size:14px;text-align:center}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>لوحة التحكم - Tax Door</header>

  <button class="logout" onclick="logout()">🚪 تسجيل الخروج</button>

  <div class="user-box" id="userBox">
    <div class="user-grid">
      <p><strong>👤 الاسم:</strong> <span id="name">—</span></p>
      <p><strong>📧 البريد:</strong> <span id="email">—</span></p>
      <p><strong>📱 الهاتف:</strong> <span id="phone">—</span></p>
      <p><strong>🆔 المعرّف (userId):</strong> <span id="userId">—</span></p>
      <p><strong>👤 اسم المستخدم:</strong> <span id="username">—</span></p>
    </div>
  </div>

  <div class="container" id="cards">
    <div class="card" onclick="openPage('download_income_declarations.html')">
      <h3>📄 إقرارات الدخل</h3>
      <p>تحميل جميع إقرارات ضريبة الدخل المسجلة.</p>
    </div>
    <div class="card" onclick="openPage('download_portal_payment_receipts.html')">
      <h3>💳 إيصالات الدفع الإلكتروني</h3>
      <p>عرض وتحميل إيصالات الدفع من البوابة.</p>
    </div>
    <div class="card" onclick="openPage('download_withholding_.html')">
      <h3>📑 نماذج الخصم والتحصيل</h3>
      <p>إدارة ملفات الخصم (نموذج 41).</p>
    </div>
    <div class="card" onclick="openPage('monthly-decleration.html')">
      <h3>📆 الإقرارات الشهرية</h3>
      <p>إدارة وتنزيل الإقرارات الشهرية بسهولة.</p>
    </div>
    <div class="card" onclick="openLegacy()">
      <h3>🗂️ لتسجيل جديد</h3>
      <p>إدخال بيانات البوابة الضريبية القديمة</p>
    </div>
  </div>

  <footer>© 2025 Tax Door System</footer>

  <!-- Spinner Overlay -->
  <div id="loadingOverlay" class="overlay" aria-live="polite" aria-busy="true">
    <div style="display:flex;flex-direction:column;align-items:center">
      <div class="spinner" role="status" aria-label="جارِ التحميل"></div>
      <div class="overlay-text">جارِ جلب بيانات الحساب…</div>
    </div>
  </div>

  <script>
    // ======== إعدادات كوجنيتو ========
    const CLIENT_ID   = "4ffqait6u9o2q22u1g39vt0454";
    const DOMAIN      = "https://us-east-1hrn5jyv1p.auth.us-east-1.amazoncognito.com";
    const REDIRECT_URI= "https://omardevolber.github.io/tax-door/";

    // ======== Spinner helpers ========
    const overlay = document.getElementById('loadingOverlay');
    function showSpinner(msg="جارِ جلب بيانات الحساب…"){
      overlay.querySelector('.overlay-text').textContent = msg;
      overlay.classList.add('show');
      // اختياري: تعطيل الكروت مؤقتًا
      document.getElementById('cards').style.pointerEvents = 'none';
    }
    function hideSpinner(){
      overlay.classList.remove('show');
      document.getElementById('cards').style.pointerEvents = '';
    }

    // ======== فك JWT مع UTF-8 ========
    function parseJwtUtf8(token){
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
      const binary = atob(base64);
      const percentEncoded = Array.prototype.map.call(binary, ch => '%' + ch.charCodeAt(0).toString(16).padStart(2,'0')).join('');
      const json = decodeURIComponent(percentEncoded);
      return JSON.parse(json);
    }

    // ======== فتح صفحات ========
    function openPage(page){ window.location.href = page; }
    function openLegacy(){
      const uid = sessionStorage.getItem("userId") || sessionStorage.getItem("useId");
      if (!uid){ alert("❗ مفيش userId في الـ sessionStorage — ارجع سجّل دخول الأول."); return; }
      window.location.href = "https://2d545906-4abd-4cc3-a694-9d80f68249c9-00-2b5dubctbx6hg.kirk.replit.dev/?userId=" + encodeURIComponent(uid);
    }

    // ======== عرض بيانات المستخدم ========
    function renderUser(){
      document.getElementById("name").textContent     = sessionStorage.getItem("name") || "غير متوفر";
      document.getElementById("username").textContent = sessionStorage.getItem("username") || "غير متوفر";
      document.getElementById("email").textContent    = sessionStorage.getItem("email") || "غير متوفر";
      document.getElementById("phone").textContent    = sessionStorage.getItem("phone_number") || "غير متوفر";
      document.getElementById("userId").textContent   = sessionStorage.getItem("userId") || "غير متوفر";
    }

    // ======== تبادل الكود بالتوكن (مع السبينر) ========
    async function exchangeCodeForToken(code){
      showSpinner(); // يبدأ السبينر هنا
      const tokenUrl = `${DOMAIN}/oauth2/token`;
      const body = new URLSearchParams({
        grant_type: "authorization_code",
        client_id: CLIENT_ID,
        code,
        redirect_uri: REDIRECT_URI
      });

      try{
        const res = await fetch(tokenUrl, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });
        const data = await res.json();

        const idToken = data.id_token;
        if(!idToken){ alert("فشل تسجيل الدخول من كوجنيتو"); hideSpinner(); return; }

        const payload = parseJwtUtf8(idToken);

        sessionStorage.setItem("userId", payload.sub || "");
        sessionStorage.setItem("username", payload['cognito:username'] || "");
        sessionStorage.setItem("email", payload.email || "");
        sessionStorage.setItem("phone_number", payload.phone_number || "");
        sessionStorage.setItem("name", payload.name || payload.given_name || "");

        // تنظيف باراميتر ?code
        if (history.replaceState) {
          const cleanUrl = location.origin + location.pathname;
          history.replaceState({}, document.title, cleanUrl);
        }

        renderUser();
      }catch(err){
        console.error(err);
        alert("حدث خطأ أثناء تسجيل الدخول");
      }finally{
        hideSpinner(); // إخفاء السبينر في كل الأحوال
      }
    }

    // ======== فحص الجلسة عند التحميل ========
    (function init(){
      const userId   = sessionStorage.getItem("userId");
      const username = sessionStorage.getItem("username");

      if (!userId || !username){
        const code = new URLSearchParams(location.search).get("code");
        if (!code){
          const scope = encodeURIComponent("aws.cognito.signin.user.admin email openid phone profile");
          window.location.href =
            `${DOMAIN}/login?client_id=${CLIENT_ID}&response_type=code&scope=${scope}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
        } else {
          exchangeCodeForToken(code); // هيظهر السبينر تلقائي
        }
      } else {
        renderUser(); // بيانات موجودة في الجلسة بالفعل
      }
    })();

    // ======== تسجيل الخروج ========
    function logout(){
      sessionStorage.clear();
      const scope = encodeURIComponent("email openid phone profile");
      window.location.href =
        `${DOMAIN}/login?client_id=${CLIENT_ID}&response_type=code&scope=${scope}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
    }
  </script>
</body>
</html>
